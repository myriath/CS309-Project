stages:
  - build
  - maven-build
  - maven-test
  - maven-deploy
  - android-build
  - android-test
  - android-deploy

variables:
  APP_VERSION: 1
  APP_NAME: backend
  MAVEN_OPTS: >-
    -Dhttps.protocols=TLSv1.2
    -Dmaven.repo.local=.m2/repository
    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
    -Dorg.slf4j.simpleLogger.showDateTime=true
    -Djava.awt.headless=true
  MAVEN_CLI_OPTS: >-
    --batch-mode
    --errors
    --fail-at-end
    --show-version
    -f Backend/backend/pom.xml
    -DinstallAtEnd=true
    -DdeployAtEnd=true

build:
  rules:
    - if: $CI_COMMIT_TAG != "springboot_tag" && $CI_COMMIT_TAG != "android_tag"
  tags:
    - springboot_tag
  stage: build
  script:
    - echo "Building..."

build-spring:
  rules:
    - if: $CI_COMMIT_TAG == "springboot_tag"
  tags:
    - springboot_tag
  stage: maven-build
  script:
    - mvn $MAVEN_CLI_OPTS verify

deploy-demo-spring:
  rules:
    - if: $CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == "springboot_tag"
  tags:
    - springboot_tag
  stage: maven-deploy
  script:
    - mvn $MAVEN_CLI_OPTS verify
    - cp Backend/backend/target/$APP_NAME-$APP_VERSION.jar /home/gitlab-runner/build/
    - ln -sf /home/gitlab-runner/build/$APP_NAME-$APP_VERSION.jar /home/gitlab-runner/build/latest.jar
    - sudo /home/gitlab-runner/deploy.sh

deploy-demoprod-spring:
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG == "springboot_tag_prod"
  tags:
    - springboot_tag
  stage: maven-deploy
  script:
    - mvn $MAVEN_CLI_OPTS verify
    - cp Backend/backend/target/$APP_NAME-$APP_VERSION.jar /home/gitlab-runner/release/
    - ln -sf /home/gitlab-runner/release/$APP_NAME-$APP_VERSION.jar /home/gitlab-runner/release/latest.jar
    - sudo /home/gitlab-runner/deployprod.sh

deploy-prod-spring:
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG == "springboot_tag_prod"
  tags:
    - deploy_tag
  stage: maven-deploy
  script:
    - mvn $MAVEN_CLI_OPTS verify
    - cp Backend/backend/target/$APP_NAME-$APP_VERSION.jar /home/gitlab-runner/release/
    - ln -sf /home/gitlab-runner/release/$APP_NAME-$APP_VERSION.jar /home/gitlab-runner/release/latest.jar
    - sudo /home/gitlab-runner/deploy.sh
